<html>
  <head>
    <title>Battery Killah</title>
    <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
    <script type="text/javascript">
      $(document).ready(function() {
        if (! localStorage in window) {
          $('#setup').html($('<p/>', {'class':'error'}).html("No localStorage support"));
          return;
        }

        var log = $('#log');

        try {
          var runs = JSON.parse(localStorage["runs"]);
        }
        catch(e) {
          alert("Busted log!");
        }

        if (runs) {
          $(runs).each(function(i,run) {
            if (!run) return;
            log.prepend($('<li/>').html(run.join("<br>")));
          });
        }
        else {
          localStorage["runs"] = JSON.stringify([]);
        }

        $('#clear').on('click', function() {
          localStorage["runs"] = null;
          $('#log').html('');
        });

        $('#start').on('click', function() {
          var urls = $('#urls').val().split(/[\s\n]/);
          var interval = $('#interval').val();

          if (urls.length == 0) {
            alert("Need some URLs");
            return;
          }

          var frame = $('#frame');
          var setup = $('#setup');

          setup.hide();
          frame.removeClass("hidden");
          frame.height($(window).height());
          frame.width($(window).width());

          var runs = JSON.parse(localStorage["runs"]);
          var current_run = runs.length + 1;
          runs[current_run] = [
            window.navigator.userAgent,
            (new Date()).toString(),
            (new Date()).toString()
          ];

          localStorage["runs"] = JSON.stringify(runs);

          var i = 0;
          frame.attr('src', urls[i++]);
          var timer = setInterval(function() {
            runs[current_run][1] = (new Date()).toString();
            localStorage["runs"] = JSON.stringify(runs);
            frame.attr('src', urls[i++]);
            if (i >= urls.length) i = 0;
          }, interval * 1000);
        });
      });
    </script>
    <style type="text/css">
      body {
        margin: 0;
        padding: 0;
        font-family: sans-serif;
      }
      .error { color: red }

      #log li {
        margin-bottom: 10px;
        line-height: 1.3em;
        font-family: monospace;
      }

      #setup {
        width: 400px;
        margin: 40px auto;
      }

      #setup input,
      #setup label,
      #setup textarea,
      #setup button {
        display : block;
      }

      #setup textarea {
        width: 400px;
        height: 200px;
        margin-bottom: 20px;
      }

      #setup input {
        width: 40px;
        margin-bottom: 20px;
      }

      #frame {
        display: block;
      }

      #frame.hidden {
        display: none;
      }
    </style>
  </head>
  <body>
    <div id="setup">
      <label for="urls">List of URLs (separated by space)</label>
      <textarea id="urls" name="urls"></textarea>
      <label for="interval">Time between refreshes (in seconds)</label>
      <input type="text" id="interval" name="interval" value="15">
      <button id="start">Start</button>
      <h3>Previous Runs</h3>
      <ul id="log"></ul>
      <button id="clear">Clear</button>
    </div>
    <iframe frameborder="0" scrolling="auto" id="frame" class="hidden"></iframe>
  </body>
</html>
